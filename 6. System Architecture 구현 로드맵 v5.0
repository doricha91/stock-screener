1. 시스템 개요 (Overview)목표: S&P500 전 종목을 데이터베이스로 관리하고, 시장 지수(SPY, QQQ)를 기반으로 시장 상황을 판단하며, 여러 전략의 신호를 종합(Ensemble)하여 확률 높은 매매 판단을 내린다.
    버전: v5.0 (Database & Ensemble Edition)

2. 데이터 수집 및 관리 (Data Layer)
    기존 CSV 방식에서 SQLite DB 방식으로 전면 개편

2.1. 데이터베이스 구조 (market_data.db)단일 파일인 SQLite를 사용하여 관리가 용이하게 함.
    Table 1: tickers (종목 마스터)
        종목의 소속 그룹을 유연하게 관리하기 위해 컬럼을 확장했습니다.
        symbol (PK): 종목코드
        name: 기업명
        sector: 섹터
        industry: 세부 산업군
        listing_board: 소속 시장 (예: SP500, NASDAQ100, RUSSELL2000) - 확장성 고려

    Table 2: daily_price (일별 시세)
        symbol (FK), date
        open, high, low, close, adj_close
        volume

    Table 3: market_index (지수 및 거시경제)
        symbol: SPY, QQQ, ^VIX(변동성), ^TNX(10년물 금리), DX-Y.NYB(달러인덱스) 등
        date, close, adj_close
        moving_avg_200: (선택 사항) DB에 저장하기보다 코드에서 계산하는 것이 관리에 용이하나, 빠른 조회를 위해 유지.

    Table 4: financials (분기별 재무 데이터 - 신규)
        가치투자를 위해 추가합니다. (yfinance의 ticker.quarterly_financials 등으로 수집)
        symbol (FK), date (발표일/기준일)
        revenue (매출), net_income (순이익)
        eps (주당순이익), total_assets (총자산), total_equity (자본)

2.2. 데이터 수집기 (data_collector.py)
    S&P500 리스트 확보: Wikipedia 등에서 최신 S&P500 티커 리스트 크롤링.
    업데이트 로직:최초 실행 시: 2000년 1월 1일부터 현재까지 전체 다운로드.
    매일 실행 시: DB의 마지막 날짜(MAX(date)) 이후 데이터만 yfinance로 증분(Incremental) 업데이트.
    벤치마크 수집: 개별 종목 수집 전, SPY, QQQ 데이터를 우선적으로 최신화.

3. 시장 상황 판단 모듈 (Market Regime)
개별 종목이 아닌, 대표 지수(Benchmark)로 거시적 환경 판단

3.1. 로직 변경
    기존: 타겟 종목(예: AAPL)이 200일선 위에 있는가?
    변경: SPY(S&P500 ETF)와 QQQ(나스닥 ETF)의 추세로 '시장 신호등' 결정.

3.2. 시장 상태 정의 (예시)
    상태 (Regime) 판단 기준 (Logic) 전략 가중치
    강세장 (Bull) SPY > 200일선 AND QQQ > 200일선 추세추종 전략 적극 반영 (매수 허용)
    불안정 (Unstable) 둘 중 하나만 200일선 위 OR VIX > 20  보수적 진입 (매수 비중 축소)
    약세장 (Bear) SPY < 200일선 AND QQQ < 200일선 신규 매수 금지 (현금 보유 100%)

4. 전략 앙상블 모듈 (Signal Ensemble)
단일 전략 의존도 탈피, 다수결/점수제 방식 도입

4.1. 개별 전략 (Voters)
    각 전략은 독립적으로 Buy(1), Neutral(0), Sell(-1) 신호를 냄.
    Trend: 터틀 트레이딩 (Turtle)
    Momentum: RSI + MACD 조합
    Mean Reversion: 볼린저 밴드 (Bollinger Bands)
    Moving Avg: DEMA (이중지수이동평균) 골든크로스

4.2. 종합 판단 로직 (The Judge)Score System: 각 전략의 신호에 가중치를 곱해 합산.
    예시 공식: $(Turtle \times 2) + (MACD \times 1) + (Bollinger \times 1)$
    최종 매수 조건:시장 필터 통과: 시장 상태가 'Bear'가 아닐 것.
    점수 충족: 합산 점수가 Threshold(임계값) 이상일 것.
    (예: 4점 만점에 3점 이상)

5. 실행 프로세스 (Work Flow)

5.1. 스크리너 (매일 아침 실행)
    DB Update: data_collector가 어제 장 마감 데이터를 DB에 저장.
    Market Check: SPY, QQQ를 조회하여 오늘이 '매수 가능일'인지 판단.
        약세장이면 프로그램 종료 (현금 관망).
    Analysis Loop: S&P500 전 종목을 순회 (SELECT * FROM tickers).
        각 종목에 대해 4가지 전략 함수 실행.
        Ensemble 점수 계산.
    Reporting: 점수가 높은 순서대로 Top 20 추천 종목 리스트 생성 및 텔레그램/슬랙 전송.

5.2. 백테스터 (전략 검증)
    Loader: DB에서 전체 과거 데이터를 메모리로 로드.
    Time Loop: 과거 시점부터 하루씩 전진하며 시뮬레이션.
        Day T: 그 당시의 SPY 기준으로 시장 판단 -> 앙상블 점수 계산 -> 매수/매도.
    Result: 단일 전략 대비 앙상블 전략의 수익률 안정성(MDD 감소 효과) 비교 분석.



A. 🗺️ 구현 로드맵 (단계별 가이드)
    PyCharm에서 작업하기 좋은 순서대로 나열했습니다.

    STEP 1: 데이터베이스 구축 (database.py) - 가장 중요
    확장성을 고려하여 테이블을 설계합니다. yfinance를 사용하므로 데이터 포맷은 쉽게 맞출 수 있습니다.
    tickers 테이블: symbol, group_code (SP500, NASDAQ100, RUSSELL2000 등 구분자 추가).
    prices 테이블: 모든 종목의 일별 시세 통합 저장.
    작업: SQLite DB를 생성하고 테이블을 만드는 코드를 먼저 작성합니다.

    STEP 2: 데이터 수집기 업그레이드 (data_collector.py)
    기존 CSV 수집 로직을 DB INSERT 로직으로 변경합니다.
    위키피디아 등에서 S&P500 티커를 긁어오는 함수 구현.
    yfinance로 데이터를 받아 DB에 없으면 추가, 있으면 최신 날짜 이후만 추가하는 증분 업데이트(Incremental Update) 기능 구현.

    STEP 3: 전략 모듈 표준화 (strategy.py)
    앙상블(합산)을 하려면 각 전략의 목소리 톤을 맞춰야 합니다.
    예: check_turtle_strategy(df) -> 결과값: 1 (매수), 0 (대기), -1 (매도/청산)
    이렇게 모든 전략 함수가 통일된 숫자 신호를 뱉도록 기존 코드를 살짝 수정합니다.

    STEP 4: 앙상블 로직 구현 (ensemble.py 또는 screener.py)
    사용자님이 말씀하신 대로 "아직 고민 중"인 부분은 유연하게 만듭니다.
    설정 파일(config.py)에 가중치를 둡니다.

    Python
        # config.py 예시
        STRATEGY_WEIGHTS = {
            'turtle': 2.0,  # 터틀 전략은 중요하니까 2점
            'rsi': 1.0,
            'macd': 0.5
        }
        THRESHOLD = 2.5 # 합산 2.5점 넘으면 매수
    이렇게 해두면 나중에 코드 수정 없이 숫자만 바꿔서 백테스트해볼 수 있습니다.

    STEP 5: 연결 및 실행 (main.py)
    위 부품들을 순서대로 호출합니다.
    DB 업데이트
    시장 지수(SPY) 확인 -> 하락장이면 종료
    상승장이면 전체 종목 로드 -> 전략 점수 계산 -> 상위 종목 출력